---
# Dev stage - auto-promotes from warehouse
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: dev
  namespace: team-alpha-webapp
spec:
  # Request Freight directly from the warehouse
  requestedFreight:
    - origin:
        kind: Warehouse
        name: team-alpha-webapp
      sources:
        direct: true
  
  # Promotion template - how to promote Freight to this stage
  promotionTemplate:
    steps:
      # Clone the Git repo
      - uses: git-clone
        config:
          repoURL: https://github.com/csz-akuity/testing-grounds.git
          checkout:
            - branch: team-alpha-project-webapp
              path: ./src
      
      # Update image references with Kustomize
      - uses: kustomize-set-image
        config:
          path: ./src
          images:
            - image: nginx
            - image: postgres
      
      # Commit and push changes
      - uses: git-commit
        config:
          path: ./src
          messageFromSteps:
            - kustomize-set-image
      - uses: git-push
        config:
          path: ./src
          branch: team-alpha-project-webapp

---
# Staging stage - requires manual promotion from dev
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: staging
  namespace: team-alpha-webapp
spec:
  # Request Freight from dev stage
  requestedFreight:
    - origin:
        kind: Warehouse
        name: team-alpha-webapp
      sources:
        stages:
          - dev
  
  # Promotion template
  promotionTemplate:
    steps:
      - uses: git-clone
        config:
          repoURL: https://github.com/csz-akuity/testing-grounds.git
          checkout:
            - branch: team-alpha-project-webapp
              path: ./src
      
      - uses: kustomize-set-image
        config:
          path: ./src
          images:
            - image: nginx
            - image: postgres
      
      - uses: git-commit
        config:
          path: ./src
          messageFromSteps:
            - kustomize-set-image
      - uses: git-push
        config:
          path: ./src
          branch: team-alpha-project-webapp
  
  # Simple verification
  verification:
    analysisTemplates:
      - name: verify-deployment-health

---
# Production stage - requires manual promotion from staging
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: prod
  namespace: team-alpha-webapp
spec:
  # Request Freight from staging stage
  requestedFreight:
    - origin:
        kind: Warehouse
        name: team-alpha-webapp
      sources:
        stages:
          - staging
  
  # Promotion template
  promotionTemplate:
    steps:
      - uses: git-clone
        config:
          repoURL: https://github.com/csz-akuity/testing-grounds.git
          checkout:
            - branch: team-alpha-project-webapp
              path: ./src
      
      - uses: kustomize-set-image
        config:
          path: ./src
          images:
            - image: nginx
            - image: postgres
      
      - uses: git-commit
        config:
          path: ./src
          messageFromSteps:
            - kustomize-set-image
      - uses: git-push
        config:
          path: ./src
          branch: team-alpha-project-webapp
  
  # Verification before considering promotion successful
  verification:
    analysisTemplates:
      - name: verify-deployment-health
